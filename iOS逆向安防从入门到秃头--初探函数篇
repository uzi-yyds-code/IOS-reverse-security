*   é›·è¿ªæ–¯ä¿ºçš„æ•å¤´ä»¬ã€‚å°è°·åˆæ¥å­¦ä¹ äº†~ ä»Šå¤©è¯´ä¸€æ³¢æ¯”è¾ƒå¸¸ç”¨--`å‡½æ•°`~

*   æœ¬äººçš„é«˜çº§äº¤æµç¾¤ï¼š1001906160ï¼Œæ¬¢è¿å„ä½ï¼

*   å…„å¼Ÿä»¬éƒ½å¬è¯´è¿‡`å‡½æ•°è°ƒç”¨æ ˆ`ï¼Œä»Šå¤©å°±ä»`æ±‡ç¼–`å±‚æ¬¡ç®€å•çš„ç†è§£ä¸‹`å‡½æ•°`~

## 1\. æ ˆ

### 1.1\. æ ˆçš„æ¦‚å¿µ

*   `å‡½æ•°è°ƒç”¨æ ˆ`çš„`æ ˆ`ï¼Œä¸æ˜¯é€šå¸¸æ‰€è¯´çš„è¯´çš„`æ•°æ®ç»“æ„`ï¼Œè¿™ä¸ªæ ˆæŒ‡çš„æ˜¯æ‹¥æœ‰ç‰¹æ®Šè®¿é—®èƒ½åŠ›çš„`å­˜å‚¨ç©ºé—´`ï¼ˆ`FILOï¼šfirst in last outï¼Œå…ˆè¿›åå‡º`ï¼‰

*   æ¥ä¸€æ³¢å›¾ï¼ˆæˆ‘æ¯”è¾ƒå–œæ¬¢å·å›¾ï¼Œå°±ç¦»è°±ğŸ˜†ï¼‰

![1.jpg](https://upload-images.jianshu.io/upload_images/19704571-ccc14d3427ecb142.image?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### 1.2\. æ ˆçš„å…³é”®ç‚¹

*   1.  ç°åœ¨`arm64`ï¼Œå·²ç»å¼±åŒ–äº†`æ ˆ`çš„å½¢å¼ï¼Œæ²¡æœ‰32ä½çš„ï¼ˆ`pushï¼Œpop`ï¼‰æ“ä½œäº†
*   2.  åœ¨`iOSå¼€å‘`ä¸­ï¼Œæ ˆæ˜¯ç”±`é«˜åœ°å€`èµ°å‘`ä½åœ°å€`å­˜å‚¨
*   3.  åœ¨`iOSå¼€å‘`ä¸­ã€‚`sp(æ ˆé¡¶æŒ‡é’ˆ)`æŒ‡å‘å­˜å‚¨æ˜¯å‘`é«˜åœ°å€`çš„
*   4.  å°è°·ç”»äº†ä¸€æ³¢å›¾~ï¼ˆè¿™ä¸ªå›¾æ˜¯æˆ‘ç”»çš„ï¼‰

![2.png](https://upload-images.jianshu.io/upload_images/19704571-47445f1fa96c8c35.image?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### 1.3\. SPå’ŒFPå¯„å­˜å™¨

> ä¸Šé¢é‚£ä¸ªå›¾ç”»çš„æ—¶å€™ç”¨çš„äº†`sp`ï¼Œä¸‹é¢è§£é‡Šä¸€ä¸‹

*   `SPå¯„å­˜å™¨`:ä¸€ç›´ä¿å­˜æ ˆé¡¶çš„åœ°å€

*   `FPå¯„å­˜å™¨`:æœ‰äº›æ—¶å€™éœ€è¦ä»–ä¿å­˜ç€æ ˆåº•çš„åœ°å€ï¼Œä¹Ÿæ˜¯X29å¯„å­˜å™¨ã€‚

> æ³¨ï¼š`arm64` æ¶æ„ï¼Œå¯¹æ ˆçš„æ“ä½œæ˜¯`16å­—èŠ‚å¯¹é½`çš„

### 1.4\. å‡½æ•°è°ƒç”¨æ ˆ

*   å…„å¼Ÿä»¬åº”è¯¥éƒ½å¬è¯´è¿‡`å‡½æ•°è°ƒç”¨æ ˆ`ï¼Œæˆ‘ä»¬ç®€å•å†™ä¸€ä¸ª`å‡½æ•°`çœ‹ä¸€æ³¢

> ç®€å•å‡½æ•°è°ƒç”¨

![3.png](https://upload-images.jianshu.io/upload_images/19704571-92da7423e189ea01.image?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

*   å¸¸è§çš„å‡½æ•°è°ƒç”¨å’Œå¼€è¾Ÿç©ºé—´~

![4.png](https://upload-images.jianshu.io/upload_images/19704571-3de1fa63e61d4f11.image?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

*   ";"ä»£è¡¨æ³¨é‡Š~

```
StackFuncDemo`stackFuncTest:
->  0x102afa20c <+0>:  stp    x29, x30, [sp, #-0x10]!;é¦–å…ˆå°†sp(æ ˆé¡¶æŒ‡é’ˆ)å‘ä½åœ°å€æ‹‰ä¼¸0x10,â€!â€ä»£è¡¨æ‹‰ä¼¸å®Œåç§»spï¼Œä¹‹åå–åœ°å€ï¼Œå­˜å‚¨x29,x30å¯„å­˜å™¨
    0x102afa210 <+4>:  mov    x29, sp ;å°†sp(æ ˆé¡¶æŒ‡é’ˆ)å­˜å‚¨çš„å€¼å‹å…¥x29
    0x102afa214 <+8>:  adrp   x0, 1
    0x102afa218 <+12>: add    x0, x0, #0xf69            ; =0xf69 
    0x102afa21c <+16>: bl     0x102afa5ac              ; symbol stub for: printf
    0x102afa220 <+20>: ldp    x29, x30, [sp], #0x10 ;å°†sp(æ ˆé¡¶æŒ‡é’ˆ)æ‰€åœ¨åœ°å€å–å€¼ç»™x29,x30ï¼Œç„¶ååœ¨å‘é«˜åœ°å€å›æ”¾0x10,ï¼ˆæ ˆå¹³è¡¡ï¼‰
    0x102afa224 <+24>: ret  ;è¿”å›
å¤åˆ¶ä»£ç 
```

> è¿™é‡Œé¢çš„å€’æ•°ç¬¬äºŒå¥ï¼Œä¸ºä»€ä¹ˆè¦æŠŠ`sp`æ‰€åœ¨åœ°å€çš„å€¼é‡æ–°èµ‹å€¼ç»™`x29,x30`?ï¼Œéš¾é“`bl`æŒ‡ä»¤çš„æ—¶å€™ï¼Œè¿™å…¶ä¸­å¯„å­˜å™¨å‘ç”Ÿæ”¹å˜äº†ï¼Ÿ

## 2\. blå’ŒretæŒ‡ä»¤

### 2.1\. blæŒ‡ä»¤

*   1.  ä¸Šé¢æˆ‘ä»¬çœ‹åˆ°äº†ï¼Œ`bl`æ“ä½œè¿‡å¥½åƒä¼šå‘ç”Ÿæ”¹å˜ã€‚è€ä¸ä½å¯‚å¯çš„æˆ‘å¿…é¡»è¦æ¥è§‚å¯Ÿä¸€æ³¢äº†
*   2.  ä¸çŸ¥é“å¤§å®¶æ˜¯å¦å’Œæˆ‘ä¸€æ ·ï¼šæˆ‘é©¬ä¸Šå»æŸ¥äº†ä¸‹`blæŒ‡ä»¤`

> å°†ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€æ”¾å…¥`lr(x30)`å¯„å­˜å™¨

> è·³è½¬åˆ°æ ‡å·å¤„æ‰§è¡ŒæŒ‡ä»¤

*   3.  é‚£æˆ‘ä»¬è§‚å¯Ÿä¸‹æ˜¯å¦æ˜¯`lr(x30)`å¯„å­˜å™¨è°ƒç”¨`bl`ä¹‹åå‘ç”Ÿæ”¹å˜å°±å¥½äº†~
*   4.  ç®€å•å†™ä¸ªå‡½æ•°åµŒå¥—è°ƒç”¨

```
void test2(){

}

void test1(){
    test2();
}

int main(int argc, char * argv[]) {

    printf("test-now\n");
//    stackFuncTest();
    test1();
    printf("test--end\nâ€);
}
å¤åˆ¶ä»£ç 
```

*   5.  æ–­ç‚¹çœ‹æ±‡ç¼–~

![5.png](https://upload-images.jianshu.io/upload_images/19704571-429f2e5636add496.image?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

> æˆ‘ä»¬è¯æ˜äº†ä¸Šé¢çš„é—®é¢˜ï¼Œ`é€šè¿‡blæŒ‡ä»¤çš„ç¡®ä¼šæ˜¯x30å¯„å­˜å™¨(åˆ«åï¼šlr)å‘ç”Ÿæ”¹å˜`

### 2.2\. ret æŒ‡ä»¤

*   `ret`æŒ‡ä»¤å…¶å®å°±æ˜¯`è¿”å›`çš„æ„æ€

*   `ret`æŒ‡ä»¤æ˜¯è·³è½¬åˆ°`x30å¯„å­˜å™¨`é‡Œé¢æ‰€æŒ‡å‘çš„`åœ°å€`~

ä½œè€…ï¼šå°è°·å…ˆæ£®
é“¾æ¥ï¼šhttps://juejin.cn/post/6942754977014251527/

